<!-- dashboard.html -->

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
    <style>
        canvas {
            font-family: 'Inter', 'Segoe UI', sans-serif;
        }
        .card h2 {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            font-weight: 600;
            color: #333;
        }
        /* üîπ Backup Banner Styling */
        #backupBanner {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 320px;
        }
        #backupBanner button {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
        }
        #backupBanner .backup-btn {
            background: #2563EB;
            color: white;
        }
        #backupBanner .later-btn {
            background: #6B7280;
            color: white;
        }
    </style>
</head>
<body>
    {% include 'authapp/navbar.html' %}

    <main class="dashboard">
        <div class="card main-dashboard-card">
            <header>
                <h1>Main Dashboard</h1>
                <select id="sortOption">
                    <option value="ascending" selected>Ascending</option>
                    <option value="descending">Descending</option>
                </select>
            </header>

            <div class="grid-container">
                <!-- Gender Distribution Card -->
                <div class="card" data-order="2">
                    <h2>Gender Distribution</h2>
                    <canvas id="genderChart"></canvas>
                    <div id="genderSummaryTable"></div>
                </div>

                <!-- Age Groups Card -->
                <div class="card" data-order="3">
                    <h2>Age Groups</h2>
                    <canvas id="ageChart"></canvas>
                    <div id="ageSummaryTable"></div>
                </div>

                <!-- Education Level Card -->
                <div class="card" data-order="4">
                    <h2>Education Level</h2>
                    <canvas id="educationChart"></canvas>
                    <div id="educationSummaryTable"></div>
                </div>

                <!-- PWD and Voter Status Card -->
                <div class="card" data-order="5">
                    <h2>PWD & Voter Status</h2>
                    <canvas id="pwdVoterChart"></canvas>
                    <div id="pwdVoterSummaryTable"></div>
                </div>

                <!-- Certificates Claimed per Month Card -->
                <div class="card" data-order="1">
                    <h2>Certificates Claimed per Month</h2>
                    <canvas id="certChart"></canvas>
                    <div id="certSummaryTable"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Backup Reminder Banner -->
    <div id="backupBanner">
        <p style="margin: 0 0 10px 0; font-weight: bold;">
            üíæ Don't forget to back up the database!
        </p>
        <div style="display: flex; gap: 8px;">
            <button onclick="performDashboardBackup()" class="backup-btn">Backup Now</button>
            <button onclick="dismissBackupBanner()" class="later-btn">Later</button>
        </div>
        <span id="dashboardBackupStatus" style="display:block; margin-top:10px; font-size: 14px;"></span>
    </div>

    <!-- Chart Data JSON -->
    <script id="dashboard-data" type="application/json">
        {
            "male": {{ male_count|default:0 }},
            "female": {{ female_count|default:0 }},
            "seniors": {{ seniors_count|default:0 }},
            "kids": {{ kids_count|default:0 }},
            "no_education": {{ no_education|default:0 }},
            "elementary": {{ elementary|default:0 }},
            "high_school": {{ high_school|default:0 }},
            "college": {{ college|default:0 }},
            "pwd": {{ pwd_count|default:0 }},
            "non_pwd": {{ non_pwd_count|default:0 }},
            "voter": {{ voter_count|default:0 }},
            "non_voter": {{ non_voter_count|default:0 }}
        }
    </script>

    <!-- Certificates JSON -->
    <script id="cert-data" type="application/json">
        {{ cert_data|safe }}
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <script>
        const data = JSON.parse(document.getElementById('dashboard-data').textContent);
        const certData = JSON.parse(document.getElementById('cert-data').textContent);

        // Gradient helper
        function createGradient(ctx, color1, color2) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            return gradient;
        }

        // ------- Gender Chart -------
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        new Chart(genderCtx, {
            type: 'pie',
            data: {
                labels: ['Male', 'Female'],
                datasets: [{
                    data: [data.male, data.female],
                    backgroundColor: [
                        createGradient(genderCtx, '#2563EB', '#60A5FA'), 
                        createGradient(genderCtx, '#DC2626', '#F87171')
                    ]
                }]
            },
            options: { 
                responsive: true, 
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: { 
                    legend: { position: 'bottom' },
                    datalabels: { color: '#fff', font: { weight: 'bold', size: 14 } }
                } 
            },
            plugins: [ChartDataLabels]
        });

        (function renderGenderSummaryBelowChart() {
            const genderCanvas = document.getElementById('genderChart');
            if (!genderCanvas) return;

            const rows = [
            { label: 'Male', value: data.male || 0 },
            { label: 'Female', value: data.female || 0 }
            ];

            const genderTableHtml = `
            <table style="width:100%; border-collapse:collapse; margin-top:12px;">
                <thead>
                <tr style="background:#2563EB; color:white; text-align:left;">
                    <th style="padding:8px;">Type</th>
                    <th style="padding:8px;">Number</th>
                </tr>
                </thead>
                <tbody>
                ${rows.map(r => `
                    <tr style="border-bottom:1px solid #ddd;">
                    <td style="padding:8px;">${r.label}</td>
                    <td style="padding:8px; font-weight:bold;">${r.value}</td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
            `;

            genderCanvas.insertAdjacentHTML('afterend', genderTableHtml);
        })();

        // ------- Age Groups -------
        const ageCtx = document.getElementById('ageChart').getContext('2d');
        new Chart(ageCtx, {
            type: 'bar',
            data: {
                labels: ['Seniors', 'Kids'],
                datasets: [{
                    label: 'Population',
                    data: [data.seniors, data.kids],
                    backgroundColor: [
                        createGradient(ageCtx, '#059669', '#34D399'),
                        createGradient(ageCtx, '#D97706', '#FBBF24')
                    ],
                    borderRadius: 12,
                    borderSkipped: false
                }]
            },
            options: { 
                responsive: true, 
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: { 
                    legend: { display: false },
                    datalabels: { color: '#000', anchor: 'end', align: 'top', font: { weight: 'bold', size: 12 } }
                },
                scales: { 
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.05)" }, ticks: { precision: 0 } } 
                } 
            },
            plugins: [ChartDataLabels]
        });

        (function renderAgeSummaryBelowChart() {
            const ageCanvas = document.getElementById('ageChart');
            if (!ageCanvas) return;

            const rows = [
            { label: 'Seniors (60 and above)', value: data.seniors || 0 },
            { label: 'Kids (Below 17)', value: data.kids || 0 }
            ];

            const ageTableHtml = `
            <table style="width:100%; border-collapse:collapse; margin-top:12px;">
                <thead>
                <tr style="background:#2563EB; color:white; text-align:left;">
                    <th style="padding:8px;">Type</th>
                    <th style="padding:8px;">Number</th>
                </tr>
                </thead>
                <tbody>
                ${rows.map(r => `
                    <tr style="border-bottom:1px solid #ddd;">
                    <td style="padding:8px;">${r.label}</td>
                    <td style="padding:8px; font-weight:bold;">${r.value}</td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
            `;

            ageCanvas.insertAdjacentHTML('afterend', ageTableHtml);
        })();

        // ------- Education -------
        const eduCtx = document.getElementById('educationChart').getContext('2d');
        new Chart(eduCtx, {
            type: 'doughnut',
            data: {
                labels: ['No Education', 'Elementary', 'High School', 'College'],
                datasets: [{
                    data: [data.no_education, data.elementary, data.high_school, data.college],
                    backgroundColor: [
                        createGradient(eduCtx, '#DC2626', '#FCA5A5'),
                        createGradient(eduCtx, '#EAB308', '#FACC15'),
                        createGradient(eduCtx, '#2563EB', '#3B82F6'),
                        createGradient(eduCtx, '#7C3AED', '#A78BFA')
                    ]
                }]
            },
            options: { 
                responsive: true, 
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: { 
                    legend: { position: 'bottom' },
                    datalabels: { color: '#fff', font: { weight: 'bold', size: 13 } }
                } 
            },
            plugins: [ChartDataLabels]
        });

        (function renderEducationSummaryBelowChart() {
            const educationCanvas = document.getElementById('educationChart');
            if (!educationCanvas) return;

            const rows = [
            { label: 'No Education', value: data.no_education || 0 },
            { label: 'Elementary', value: data.elementary || 0 },
            { label: 'High School', value: data.high_school || 0 },
            { label: 'College', value: data.college || 0 },
            ];

            const educationTableHtml = `
            <table style="width:100%; border-collapse:collapse; margin-top:12px;">
                <thead>
                <tr style="background:#2563EB; color:white; text-align:left;">
                    <th style="padding:8px;">Type</th>
                    <th style="padding:8px;">Number</th>
                </tr>
                </thead>
                <tbody>
                ${rows.map(r => `
                    <tr style="border-bottom:1px solid #ddd;">
                    <td style="padding:8px;">${r.label}</td>
                    <td style="padding:8px; font-weight:bold;">${r.value}</td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
            `;

            educationCanvas.insertAdjacentHTML('afterend', educationTableHtml);
        })();

        // ------- PWD & Voter -------
        const pwdCtx = document.getElementById('pwdVoterChart').getContext('2d');
        new Chart(pwdCtx, {
            type: 'bar',
            data: {
                labels: ['PWD', 'Non-PWD', 'Voter', 'Non-Voter'],
                datasets: [{
                    label: 'Population',
                    data: [data.pwd, data.non_pwd, data.voter, data.non_voter],
                    backgroundColor: [
                        createGradient(pwdCtx, '#DC2626', '#F87171'),
                        createGradient(pwdCtx, '#2563EB', '#60A5FA'),
                        createGradient(pwdCtx, '#059669', '#34D399'),
                        createGradient(pwdCtx, '#D97706', '#FBBF24')
                    ],
                    borderRadius: 12,
                    borderSkipped: false
                }]
            },
            options: { 
                responsive: true, 
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: { 
                    legend: { display: false },
                    datalabels: { color: '#000', anchor: 'end', align: 'top', font: { weight: 'bold', size: 12 } }
                },
                scales: { 
                    x: { grid: { display: false } },
                    y: { beginAtZero:true, grid: { color: "rgba(0,0,0,0.05)" }, ticks:{precision:0} } 
                } 
            },
            plugins: [ChartDataLabels]
        });

        (function renderPwdVoterSummaryBelowChart() {
            const pwdVoterCanvas = document.getElementById('pwdVoterChart');
            if (!pwdVoterCanvas) return;

            const rows = [
            { label: 'PWD', value: data.pwd || 0 },
            { label: 'Non PWD', value: data.non_pwd || 0 },
            { label: 'Voter', value: data.voter || 0 },
            { label: 'Non Voter', value: data.non_voter || 0 },
            ];

            const pwdVoterTableHtml = `
            <table style="width:100%; border-collapse:collapse; margin-top:12px;">
                <thead>
                <tr style="background:#2563EB; color:white; text-align:left;">
                    <th style="padding:8px;">Type</th>
                    <th style="padding:8px;">Number</th>
                </tr>
                </thead>
                <tbody>
                ${rows.map(r => `
                    <tr style="border-bottom:1px solid #ddd;">
                    <td style="padding:8px;">${r.label}</td>
                    <td style="padding:8px; font-weight:bold;">${r.value}</td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
            `;

            pwdVoterCanvas.insertAdjacentHTML('afterend', pwdVoterTableHtml);
        })();

        // ------- Certificates per Month -------
        const certCtx = document.getElementById('certChart').getContext('2d');
        const certLabels = Object.keys(certData); 
        const certTypes = [...new Set(Object.values(certData).flatMap(month => Object.keys(month)))];

        const palette = [
            ['#7E22CE','#C4B5FD'],
            ['#924005','#FCD34D'],
            ['#1D4ED8','#93C5FD'],
            ['#4B5563','#9CA3AF'],
            ['#15803D','#86EFAC'],
            ['#EA580C','#FB923C'],
            ['#BE185D','#F472B6'],
            ['#2563EB','#60A5FA'], 
            ['#DC2626','#F87171'], 
            ['#059669','#34D399'], 
            ['#D97706','#FBBF24'], 
            ['#7C3AED','#A78BFA'], 
            ['#0EA5E9','#38BDF8'], 
            ['#14B8A6','#2DD4BF']  
        ];

        const certDatasets = certTypes.map((type, i) => ({
            label: type,
            data: certLabels.map(m => certData[m][type] || 0),
            backgroundColor: createGradient(certCtx, palette[i % palette.length][0], palette[i % palette.length][1]),
            borderRadius: 12,
            borderSkipped: false
        }));

        new Chart(certCtx, {
            type: 'bar',
            data: { labels: certLabels, datasets: certDatasets },
            options: {
                responsive: true,
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 14, weight: 'bold' }, color: '#333' } },
                    datalabels: { color: '#000', anchor: 'end', align: 'top', font: { weight: 'bold', size: 13 }, formatter: (v) => v>0?v:'' }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 13, weight: 'bold' }, color: '#444' } },
                    y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.05)" }, ticks: { precision: 0, font: { size: 12 }, color: '#666' } }
                }
            },
            plugins: [ChartDataLabels]
        });

                // ------- Generate Summary Table -------
        function generateCertSummaryTable(certData) {
            const summary = {};

            // Calculate totals for each certificate type
            Object.values(certData).forEach(monthData => {
                Object.entries(monthData).forEach(([type, count]) => {
                    summary[type] = (summary[type] || 0) + count;
                });
            });

            const tableContainer = document.getElementById('certSummaryTable');
            tableContainer.innerHTML = `
                <table id="sortableTable" style="width:100%; border-collapse:collapse; margin-top:20px;">
                    <thead>
                        <tr style="background:#2563EB; color:white; text-align:left; cursor:pointer;">
                            <th style="padding:8px;" data-type="text">Type of Certificate ‚¨ç</th>
                            <th style="padding:8px;" data-type="number">Number of Claimed Certificates ‚¨ç</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(summary).map(([type, total]) => `
                            <tr style="border-bottom:1px solid #ddd;">
                                <td style="padding:8px;">${type}</td>
                                <td style="padding:8px; font-weight:bold;">${total}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // Add sorting feature
            makeTableSortable(document.getElementById('sortableTable'));
        }

        // ------- Sort Functionality -------
        function makeTableSortable(table) {
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const type = header.dataset.type;
                    const ascending = header.classList.toggle('asc');

                    rows.sort((a, b) => {
                        const aText = a.children[index].textContent.trim();
                        const bText = b.children[index].textContent.trim();

                        if (type === 'number') {
                            return ascending ? aText - bText : bText - aText;
                        } else {
                            return ascending ? aText.localeCompare(bText) : bText.localeCompare(aText);
                        }
                    });

                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

// Call the function after chart loads
generateCertSummaryTable(certData);

        // ---- Sidebar Toggle ----
        function toggleSidebar() {
            const sidebar = document.querySelector(".sidebar");
            const toggleIcon = document.querySelector(".toggle-icon");
            sidebar.classList.toggle("collapsed");
            toggleIcon.innerHTML = sidebar.classList.contains("collapsed") ? "&#8594;" : "&#8592;";
        }

        // ---- Sort Cards ----
        document.addEventListener("DOMContentLoaded", function () {
            const sortSelect = document.getElementById("sortOption");
            const gridContainer = document.querySelector(".grid-container");

            function sortCards(order) {
                const cards = Array.from(gridContainer.querySelectorAll(".card"));
                cards.sort((a, b) => {
                    const aOrder = parseInt(a.getAttribute('data-order'));
                    const bOrder = parseInt(b.getAttribute('data-order'));
                    return order === "ascending" ? aOrder - bOrder : bOrder - aOrder;
                });
                gridContainer.innerHTML = "";
                cards.forEach(card => gridContainer.appendChild(card));
            }

            sortCards(sortSelect.value);
            sortSelect.addEventListener("change", () => sortCards(sortSelect.value));
        });
    </script>

    <script>
    (function() {
        const backupUrl = "{% url 'backup_database' %}";
        const csrfToken = "{{ csrf_token }}";

        // Change here: 7 days in milliseconds
        const snoozeTime = 7 * 24 * 60 * 60 * 1000; 

        function checkBackupReminder() {
            const banner = document.getElementById("backupBanner");
            const lastDismiss = localStorage.getItem("lastBackupDismiss");
            const now = Date.now();

            if (!lastDismiss) {
                // First time ‚Üí show immediately
                banner.style.display = "block";
            } else {
                const diff = now - parseInt(lastDismiss, 10);
                if (isNaN(diff) || diff > snoozeTime) {
                    banner.style.display = "block";
                }
            }
        }

        window.dismissBackupBanner = function() {
            document.getElementById("backupBanner").style.display = "none";
            localStorage.setItem("lastBackupDismiss", Date.now());
        }

        window.performDashboardBackup = async function() {
            const statusElem = document.getElementById("dashboardBackupStatus");
            statusElem.style.color = "white";
            statusElem.textContent = "‚è≥ Backing up database...";

            try {
                const response = await fetch(backupUrl, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                if (result.success) {
                    statusElem.style.color = "lightgreen";
                    statusElem.textContent = "‚úÖ Backup successful!";
                    localStorage.setItem("lastBackupDismiss", Date.now());
                    setTimeout(() => dismissBackupBanner(), 2000);
                } else {
                    throw new Error(result.error || "Backup failed");
                }
            } catch (error) {
                statusElem.style.color = "red";
                statusElem.textContent = "‚ùå Backup failed: " + error.message;
            }
        }

        document.addEventListener("DOMContentLoaded", checkBackupReminder);

    })();

</script>

</body>
</html>